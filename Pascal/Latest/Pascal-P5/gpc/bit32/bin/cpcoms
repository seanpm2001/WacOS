#!/bin/bash
#
# Script to run a pcom self compile
#
# Run macro preprocessor to configure source for self compile.
#
pascpp source/pcom -DWRDSIZ32 -DSELF_COMPILE
#
# Compile pcom to intermediate code using its binary version.
#
echo Compiling pcom to intermediate code
compile source/pcom.mpp
if [ $? -ne 0 ]
then

    echo "*** Compile failed"
    exit 1

fi
cat source/pcom.mpp.err
#
# Now run that code on the interpreter and have it compile itself
# to intermediate again.
#
echo Running pcom to compile itself
cat source/pcom.mpp.p5 source/pcom.mpp.pas > tmp.p5
mv source/pcom.mpp.p5 source/pcom.mpp.p5.org
cp tmp.p5 source/pcom.mpp.p5
echo > source/pcom.mpp.inp
run source/pcom.mpp
cat source/pcom.mpp.lst
#
# Now we have the original intermediate from the binary version
# of pcom, and the intermediate generated by the interpreted
# pcom. Compare them for equality. Put the result in pcom.dif.
#
echo "Comparing the intermediate code for the runs ... "
diffnole source/pcom.mpp.p5.org source/pcom.mpp.out > source/pcom.mpp.dif
#
# Show the file, so if the length is zero, it compared ok.
#
if [ -s source/pcom.mpp.dif ]
then
    echo "*** FAILED"
else
    echo "PASS"
fi
echo
